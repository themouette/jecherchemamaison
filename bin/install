#!/bin/bash
echo "This is the install script for development only"
echo "Report to README for other environment installation"

REPO_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )"
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )/../.." && pwd )"
GROUP="$(groups|awk '{print $1;}')"

# Create directories required by docker images
# --------------------------------------------

mkdir -p "${REPO_DIR}/docker/nginx/public"
touch "${REPO_DIR}/docker/nginx/public/.keep"

# Create fig repositories
# -----------------------

mkdir -p "${REPO_DIR}/.fig/store/data"
# temporary fix while using NeDB
[[ ! -d "${REPO_DIR}/data" ]] && mkdir -p ${REPO_DIR}/data

# Install assets
# --------------

fig -f "${REPO_DIR}/fig.yml" run npm install
fig -f "${REPO_DIR}/fig.yml" run npm release
sudo chown -R "$USER:$GROUP" ./public ./node_modules

# Install express-user
# --------------------

# Clone express user to add ability to heck on it while developping.
[[ -d "${DIR}/express-users" ]] || git clone https://github.com/themouette/express-users.git "${DIR}/express-users"
# Install a development link for express-users
if [[ ! -L node_modules/express-users ]]
then
    mkdir -p "${REPO_DIR}/node_modules"
    # remove if not a symlink
    [[ ! -L node_modules/express-users ]] && rm -rf node_modules/express-users
    ln -s "../../express-users" "${REPO_DIR}/node_modules/express-users"
fi
